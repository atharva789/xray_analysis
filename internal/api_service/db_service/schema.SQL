CREATE TABLE ACCOUNTS (
  AID SERIAL PRIMARY KEY,
  USERNAME VARCHAR(100) NOT NULL UNIQUE,
  FNAME VARCHAR(100) NOT NULL,
  LNAME VARCHAR(100) NOT NULL,
  PSWRD_HASH BYTEA NOT NULL,
  DOB DATE NOT NULL,
  CREATED_AT TIMESTAMP DEFAULT NOW()
);

CREATE TABLE PATIENTS (
  AID INT NOT NULL,
  MRN INT UNIQUE NOT NULL,
  PRIMARY KEY (AID),
  FOREIGN KEY (AID) REFERENCES ACCOUNTS(AID)
);

CREATE TABLE FILERECORDS (
  FILE_ID SERIAL PRIMARY KEY,
  FILETYPE VARCHAR(50) NOT NULL CHECK (FILETYPE IN ('slice', 'mask')),
  OBJECT_KEY VARCHAR(255) NOT NULL --s3 object key
  -- type: DICOM, mask, etc.
);

CREATE TABLE PATIENT_STATS (
  STAT_ID SERIAL PRIMARY KEY,
  AGASTON_SCORE INT
);

CREATE TABLE DICOMS (
  DICOM_ID SERIAL PRIMARY KEY,
  DICOM_NAME VARCHAR(100) NOT NULL,
  STAT_ID INT,
  CREATED_AT TIMESTAMP DEFAULT NOW(),
  FOREIGN KEY (STAT_ID) REFERENCES PATIENT_STATS(STAT_ID)
);

CREATE TABLE DICOMFILES (
  DICOM_ID INT NOT NULL,
  FILE_ID INT NOT NULL,
  PRIMARY KEY (DICOM_ID, FILE_ID),
  FOREIGN KEY (DICOM_ID) REFERENCES DICOMS(DICOM_ID),
  FOREIGN KEY (FILE_ID) REFERENCES FILERECORDS(FILE_ID)
);

CREATE TABLE PATIENTDICOMS (
  PATIENT_ID INT NOT NULL,
  DICOM_ID INT NOT NULL,
  PRIMARY KEY (PATIENT_ID, DICOM_ID),
  FOREIGN KEY (PATIENT_ID) REFERENCES PATIENTS(AID),
  FOREIGN KEY (DICOM_ID) REFERENCES DICOMS(DICOM_ID)
);

CREATE TABLE PATIENTFILES (
  FILE_ID INT NOT NULL,
  AID INT NOT NULL,
  PRIMARY KEY (FILE_ID, AID),
  FOREIGN KEY (FILE_ID) REFERENCES FILERECORDS(FILE_ID),
  FOREIGN KEY (AID) REFERENCES PATIENTS(AID)
);
